# Refrecto (β) System Design Document

## 1. 概要
本アプリケーションは、学生の時間管理能力とメタ認知を向上させるためのツールです。
「見積もり」と「実績」の差分（時間負債）を可視化し、タイマーログから「実績ガントチャート」を自動生成します。

## 1.1 UIレイアウト構成
- **Mobile (< 768px)**: 縦一列のシングルカラム配置。画面全体（Body）がスクロールする。
- **Desktop (>= 768px)**: 画面全体はスクロール不可（`h-screen` Fixed）。
  - **左カラム**: Timer, TaskForm (内部スクロール)
  - **右カラム**: TaskList (内部スクロール)


## 2. ファイル構造 (ディレクトリ構成)

```
src/
├── components/
│   ├── Layout.jsx         # ヘッダー・メインエリアを含む共通レイアウト
│   ├── TaskForm.jsx       # タスク登録・見積もり・締切入力
│   ├── TaskList.jsx       # タスク一覧・ステータス変更
│   ├── Timer.jsx          # アクティブタスクの計測・サブタスク入力
│   ├── Timer.jsx          # アクティブタスクの計測・サブタスク入力
│   ├── TaskOverlay.jsx    # タスク詳細モーダル (Dashboard & Ganttを含む)
│   ├── TaskAnalytics.jsx  # 時間負債の計算と表示
│   └── GanttChart.jsx     # タイマーログに基づく実績ガントチャート表示 (Overlay内で使用)
├── hooks/                 ## hook: UseStateやUseEffectのようなノリで、カスタムされたオリジナルのフローをコードにしたもの
│   ├── useTasks.js        # Firestore: tasksコレクションのCRUD
│   └── useTimeLogs.js     # Firestore: timeLogsコレクションのCRUD (## CRUD: Create, Read, Update, Deleteの四種類の機能)
├── lib/
│   └── firebase.js        # Firebase初期化設定
├── App.jsx                # メイン画面の構成 (Timer, TaskForm, TaskList, Overlayの配置)
└── main.jsx               # エントリーポイント
```

## 3. データ構造 (Firestore Schema)

### Collection: `tasks`
タスクの基本情報を管理します。

| Field | Type | Description |
|---|---|---|
| `documentId` | string | 自動生成ID |
| `title` | string | タスク名 |
| `estimatedMinutes` | number | 見積もり時間 (分) |
| `deadline` | timestamp | 締切日 |
| `status` | string | 'TODO', 'DOING', 'DONE' |
| `isDeleted` | boolean | 非表示フラグ (default: false) |
| `createdAt` | timestamp | 作成日時 |

### Collection: `timeLogs`
タイマーによる実行ログを管理します。ガントチャートの元データとなります。

| Field | Type | Description |
|---|---|---|
| `documentId` | string | 自動生成ID |
| `taskId` | string | `tasks` ドキュメントへの参照ID |
| `subTaskName` | string | (Option) その時行っていた具体的な作業名 |
| `startTime` | timestamp | 計測開始時刻 |
| `endTime` | timestamp | 計測終了時刻 |
| `durationSeconds` | number | 実働時間 (秒) - 集計算出用 |
| `createdAt` | timestamp | ログ作成日時 |

## 4. コンポーネント詳細設計

### 4.1 TaskForm
- **機能**: ユーザーがタスクを登録する。
- **UI要素**:
  - タイトル入力 (Text)
  - 見積もり時間入力 (Number)
  - 締切日選択 (Date Input)
  - 「登録」ボタン

### 4.2 Timer
- **機能**: 作業時間をリアルタイムで計測する。
- **UI要素**:
  - 取り組むタスクの選択 (Dropdown: DOING/TODOのタスク)
  - サブタスク名入力 (Text: 「資料探し」など)
  - Start / Stop ボタン
  - 経過時間のリアルタイム表示（ブラウザのスリープ等によるズレを防ぐため、1秒ごとに「現在時刻 - 開始時刻」を再計算して表示する）
- **挙動**: Stop時に `durationSeconds` を計算してDBへ保存する。**この時、タスクのステータスが 'TODO' であれば自動的に 'DOING' に更新する。**

  ### 4.2.1 Timer (事後報告) 
  - **補足**: 4.2 Timerの表示領域の右上に配置したボタンを押すと、作業の事後報告用モーダルを表示する。
  - **機能**: 作業時間を事後報告する。
  - **UI要素**:
    - 取り組んだタスクの選択 (Dropdown: DOING/TODOのタスク)
    - サブタスク名入力 (Text: 「資料探し」など)
    - 経過時間入力 (Number)
    - 「報告」ボタン
  - **挙動**: 「報告」ボタンを押すと、DBへ保存する。

### 4.3 タスク一覧
- **機能**: タスク一覧を表示する。
- **UI要素**:
  - タスク一覧
  - タスクのステータス変更
  - **時間負債表示**: 
    - ステータスが 'DOING' のタスクについて、時間負債（実績合計 - 見積もり）を分単位で表示する（例: `+10min`, `-5min`）。
  - **タスクの完了ボタン**: 
    - クリックすると、「『タスク名』を完了しますか？」と確認モーダルを表示し、ユーザーの同意を得た場合はタスクのステータスを即座に 'DONE' に変更し、モーダルを閉じる。同意を得なかった場合はモーダルに戻る。
    - タスクがDONEになった場合、タスクの完了ボタンを置き換える形でタスクの非表示ボタンを表示する。
- **挙動**: 
  - タスクをクリックするとTask Overlay Modal ( 4.3.1 )を表示する。

  ### 4.3.1 Task Overlay (Modal)
  - **機能**: タスク一覧にある任意のタスクをクリックした際に表示される詳細ポップアップ。
  - **構成**:
    1. **TaskAnalytics**: 選択されたタスクの「時間負債」を表示。
      - (そのタスクの実績合計) - (見積もり) を計算。
    2. **GanttChart(4.3.2)**: 選択されたタスクに関連する `timeLogs` のみをフィルタリングして、横スクロール可能な水平スタックバーチャートとして表示する。
    3. **タスクの編集ボタン**: 選択されたタスクの名前や締め切り時間、見積もり時間の編集を可能とする。
    4. **タスクの削除ボタン**: 選択されたタスクの削除を可能とする。

  ### 4.3.2 GanttChart (Component)
  - **機能**: 渡された `timeLogs` を「積み上げ式」のバーチャートとして描画する。
  - **仕様**:
    - **表示形式**: 横スクロール可能な水平スタックバーチャート。
    - **横軸**: 経過時間 (開始0分から、30分ごとの目盛りを表示)。
    - **コンテンツ**: 各ログ（サブタスク）を、所要時間(duration)に応じた幅で、左から詰めて配置する（隙間時間を作らない）。
    - **見た目**: 
      - 「タスク名」のレーンに対し、作業ログが隙間なく連結された一本のバーのように見える。
      - バー内には「サブタスク名」を表示する。
    - **レスポンシブ挙動**:
      - 表示領域(コンテナ幅)よりもチャートが長くなる場合、自動的に縮小して領域内に収まるようにスケーリングする(最小スケール適用)。
      - 領域に余裕がある場合は、標準スケール(3px/分)で描画する。

  ### 4.3.3 タスクの編集ボタン
  - **機能**: 選択されたタスクの名前や締め切り時間、見積もり時間の編集を可能とする。
  - **UI要素**:
    - タスク名入力 (Text)
    - 締切日選択 (Date Input)
    - 見積もり時間入力 (Number)
    - 「保存」ボタン
    - 「キャンセル」ボタン
  - **挙動**: 「保存」ボタンを押すと、変更内容をDBへ保存する。 「キャンセル」ボタンを押すと、モーダル(4.3.1)に戻る。

  ### 4.3.4 タスクの完了ボタン
  - **機能**: タスクを「完了」状態にする。
  - **UI要素**:
    - 「完了」ボタン (Checkアイコン等)
  - **挙動**: 
    - クリックすると、「『タスク名』を完了しますか？」と確認モーダルを表示し、ユーザーの同意を得た場合はタスクのステータスを即座に 'DONE' に変更し、モーダルを閉じる。同意を得なかった場合はモーダルに戻る。
    - タスクがDONEになった場合、タスク一覧から非表示にするボタンがタスクの「DONE」の左に出てくる。

  ### 4.3.5 タスクの物理削除ボタン
  - **機能**: 選択されたタスクを完全に削除する。
  - **UI要素**:
    - 「完全に削除」ボタン（テキストリンクや赤色のゴミ箱アイコンなど、誤操作を防ぐ配置）
  - **挙動**: 
    - クリック時に「関連する作業ログを含めて完全に削除しますか？」と警告を含む確認モーダルを表示する。
    - 同意が得られた場合、以下を実行する:
      1. `tasks` コレクションから該当ドキュメントを削除 (`deleteDoc`)。
      2. `timeLogs` コレクションから該当タスクIDを持つ全てのログを削除 (Cascade Delete)。
    - 完了後、モーダルを閉じ一覧へ戻る。

## 5. 技術スタック & 開発ルール

- **Core**: React, Vite
- **Styling**: Tailwind CSS (ユーティリティクラスを活用し、CSSファイル作成を減らす)
- **Backend**: Firebase Firestore
- **Coding Style**:
  - **Custom Hooks**: データの取得・保存ロジックは必ず `hooks/` ディレクトリに分離する。コンポーネント内に `uEffect` で直接 `onSnapshot` を書かない。
  - **段階的実装**: UI実装(固定値) → State実装(機能動作) → DB接続 の順で進める。
